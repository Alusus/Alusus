import "libalusus_spp.so";

@expname[printf] func print(format: ptr[Word[8]], args: ...any): Int[32];

type A
{
  def i: Int;

  func print {
    print("this.i = %d\n", this.i);
  };

  func setI (i: Int) {
    this.i = i;
  };

  @shared func setI2 (this: ref[this_type], i: Int) {
    this.i = i;
  };
};

type B
{
  def a: A;
  def f: ptr[function];

  on this~init() this.a.i = 7;
  on this~init(that: ref[this_type]) this.a = that.a;

  func getMyVal ()=>B {
    return this;
  };

  func getMyRef ()=>ref[B] {
    return this;
  };
};

func test {
  def a: A;
  a.setI(10);
  a.setI2(10);
  a.print();

  def b: B;
  b.a.print();
  b.getMyVal().a.print();
  b.getMyRef().a.print();
};

Spp.dumpLlvmIrForElement(test~ast);

type C
{
  def i: Int;

  func setI (this: ref[this_type], i: Int) {
    this.i = i;
  };
};

func testError {
  def c: C;
  c.setI(10);
};

Spp.dumpLlvmIrForElement(testError~ast);
